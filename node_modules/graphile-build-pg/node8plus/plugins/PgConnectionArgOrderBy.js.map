{"version":3,"sources":["../../src/plugins/PgConnectionArgOrderBy.js"],"names":["PgConnectionArgOrderBy","builder","hook","_","build","newWithHooks","pgIntrospectionResultsByKind","introspectionResultsByKind","graphql","GraphQLEnumType","inflection","pgOmit","omit","sqlCommentByAddingTags","describePgEntity","class","filter","table","isSelectable","namespace","forEach","tableTypeName","tableType","name","orderByType","description","values","NATURAL","value","alias","specs","__origin","pgIntrospection","isPgRowSortEnum","args","context","extend","getTypeByName","pgGetGqlTypeByTypeIdAndModifier","pgSql","sql","GraphQLList","GraphQLNonNull","scope","isPgFieldConnection","isPgFieldSimpleCollection","pgFieldIntrospection","addArgDataGenerator","Self","field","shouldAddOrderBy","kind","TableType","type","id","TableOrderByType","cursorPrefixFromOrderBy","orderBy","cursorPrefixes","item","push","literal","length","connectionOrderBy","rawOrderBy","Array","isArray","pgCursorPrefix","pgQuery","queryBuilder","unique","orders","col","ascending","expr","fragment","getTableAlias","identifier","setOrderIsUnique"],"mappings":"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","file":"PgConnectionArgOrderBy.js","sourcesContent":["// @flow\nimport isString from \"lodash/isString\";\nimport type { Plugin } from \"graphile-build\";\n\nexport default (function PgConnectionArgOrderBy(builder) {\n  builder.hook(\"init\", (_, build) => {\n    const {\n      newWithHooks,\n      pgIntrospectionResultsByKind: introspectionResultsByKind,\n      graphql: { GraphQLEnumType },\n      inflection,\n      pgOmit: omit,\n      sqlCommentByAddingTags,\n      describePgEntity,\n    } = build;\n    introspectionResultsByKind.class\n      .filter(table => table.isSelectable && !omit(table, \"order\"))\n      .filter(table => !!table.namespace)\n      .forEach(table => {\n        const tableTypeName = inflection.tableType(table);\n        /* const TableOrderByType = */\n        newWithHooks(\n          GraphQLEnumType,\n          {\n            name: inflection.orderByType(tableTypeName),\n            description: `Methods to use when ordering \\`${tableTypeName}\\`.`,\n            values: {\n              NATURAL: {\n                value: {\n                  alias: null,\n                  specs: [],\n                },\n              },\n            },\n          },\n          {\n            __origin: `Adding connection \"orderBy\" argument for ${describePgEntity(\n              table\n            )}. You can rename the table's GraphQL type via:\\n\\n  ${sqlCommentByAddingTags(\n              table,\n              {\n                name: \"newNameHere\",\n              }\n            )}`,\n            pgIntrospection: table,\n            isPgRowSortEnum: true,\n          }\n        );\n      });\n    return _;\n  });\n  builder.hook(\n    \"GraphQLObjectType:fields:field:args\",\n    (args, build, context) => {\n      const {\n        extend,\n        getTypeByName,\n        pgGetGqlTypeByTypeIdAndModifier,\n        pgSql: sql,\n        graphql: { GraphQLList, GraphQLNonNull },\n        inflection,\n        pgOmit: omit,\n      } = build;\n      const {\n        scope: {\n          isPgFieldConnection,\n          isPgFieldSimpleCollection,\n          pgFieldIntrospection: table,\n        },\n        addArgDataGenerator,\n        Self,\n        field,\n      } = context;\n      const shouldAddOrderBy = isPgFieldConnection || isPgFieldSimpleCollection;\n      if (\n        !shouldAddOrderBy ||\n        !table ||\n        table.kind !== \"class\" ||\n        !table.namespace ||\n        !table.isSelectable ||\n        omit(table, \"order\")\n      ) {\n        return args;\n      }\n      const TableType = pgGetGqlTypeByTypeIdAndModifier(table.type.id, null);\n      const tableTypeName = TableType.name;\n      const TableOrderByType = getTypeByName(\n        inflection.orderByType(tableTypeName)\n      );\n      const cursorPrefixFromOrderBy = orderBy => {\n        if (orderBy) {\n          let cursorPrefixes = [];\n          for (const item of orderBy) {\n            if (item.alias) {\n              cursorPrefixes.push(sql.literal(item.alias));\n            }\n          }\n          if (cursorPrefixes.length > 0) {\n            return cursorPrefixes;\n          }\n        }\n        return null;\n      };\n\n      addArgDataGenerator(function connectionOrderBy({ orderBy: rawOrderBy }) {\n        const orderBy = rawOrderBy\n          ? Array.isArray(rawOrderBy)\n            ? rawOrderBy\n            : [rawOrderBy]\n          : null;\n        return {\n          pgCursorPrefix: cursorPrefixFromOrderBy(orderBy),\n          pgQuery: queryBuilder => {\n            if (orderBy != null) {\n              orderBy.forEach(item => {\n                const { specs, unique } = item;\n                const orders =\n                  Array.isArray(specs[0]) || specs.length === 0\n                    ? specs\n                    : [specs];\n                orders.forEach(([col, ascending]) => {\n                  const expr = isString(col)\n                    ? sql.fragment`${queryBuilder.getTableAlias()}.${sql.identifier(\n                        col\n                      )}`\n                    : col;\n                  queryBuilder.orderBy(expr, ascending);\n                });\n                if (unique) {\n                  queryBuilder.setOrderIsUnique();\n                }\n              });\n            }\n          },\n        };\n      });\n\n      return extend(\n        args,\n        {\n          orderBy: {\n            description: `The method to use when ordering \\`${tableTypeName}\\`.`,\n            type: new GraphQLList(new GraphQLNonNull(TableOrderByType)),\n          },\n        },\n        `Adding 'orderBy' argument to field '${field.name}' of '${Self.name}'`\n      );\n    }\n  );\n}: Plugin);\n"]}